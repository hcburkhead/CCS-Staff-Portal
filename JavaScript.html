<script>
function toggleFolder(folderId, event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  const folderContent = document.getElementById(folderId);
  const caret = document.getElementById(`${folderId}-caret`);
  
  if (folderContent.classList.contains('show')) {
    folderContent.classList.remove('show');
    caret.classList.remove('bi-caret-down-fill');
    caret.classList.add('bi-caret-right-fill');
  } else {
    folderContent.classList.add('show');
    caret.classList.remove('bi-caret-right-fill');
    caret.classList.add('bi-caret-down-fill');
  }
}

function showSection(sectionId, clickedLink) {
  event.preventDefault();
  
  const sections = document.getElementsByClassName('content-section');
  for (let section of sections) {
    section.style.display = 'none';
  }
  
  document.getElementById(sectionId).style.display = 'block';
  
  const navLinks = document.getElementsByClassName('nav-link');
  for (let link of navLinks) {
    link.classList.remove('active');
  }
  if (clickedLink) {
    clickedLink.classList.add('active');
  }

  switch(sectionId) {
    case 'dnp':
      loadDNPContent();
      break;
    case 'resources':
      loadStaffResources();
      break;
  }
  
  return false;
}

function loadDNPContent() {
  google.script.run
    .withSuccessHandler(function(fileInfo) {
      const content = document.getElementById('dnpContent');
      if (fileInfo && fileInfo.id) {
        content.innerHTML = `
          <div class="pdf-frame-container mb-3">
            <iframe 
                    src="https://drive.google.com/file/d/${fileInfo.id}/preview?embedded=true&rm=minimal" 
                    frameborder="0" 
                    class="custom-pdf-frame"
                    allow="autoplay; encrypted-media" 
                    allowfullscreen>
            </iframe>
          </div>
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Last updated: ${fileInfo.lastUpdated}
          </div>
        `;
      } else {
        content.innerHTML = `
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            DNP list is currently unavailable. Please try again later.
          </div>
        `;
      }
    })
    .withFailureHandler(function(error) {
      document.getElementById('dnpContent').innerHTML = `
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-circle"></i>
          Error loading DNP list: ${error.message}
        </div>
      `;
    })
    .getDNPFileUrl();
}

function loadStaffResources() {
  google.script.run
    .withSuccessHandler(function(resources) {
      const documentsContainer = document.getElementById('staffDocuments');
      if (resources.documents && resources.documents.length > 0) {
        documentsContainer.innerHTML = resources.documents.map((item, index) => {
          if (item.isFolder) {
            const folderId = `docs-folder-${index}`;
            const subfolderContents = item.contents.map(subItem => `
              <a href="${subItem.url}" target="_blank" 
                 class="list-group-item list-group-item-action ms-3">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">${subItem.name}</h6>
                  <small class="text-muted">${subItem.lastUpdated}</small>
                </div>
              </a>
            `).join('');
            
            return `
              <div class="list-group-item">
                <h5 class="mb-1 folder-header" onclick="toggleFolder('${folderId}', event)">
                  <i class="bi bi-folder-fill me-2"></i>
                  <i class="bi bi-caret-right-fill" id="${folderId}-caret"></i>
                  ${item.name}
                </h5>
                <div class="collapse" id="${folderId}">
                  ${subfolderContents}
                </div>
              </div>
            `;
          } else {
            return `
              <a href="${item.url}" target="_blank" 
                 class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1">
                  <i class="bi bi-file-text me-2"></i>
                  ${item.name}
                </h5>
                <small class="text-muted">${item.lastUpdated}</small>
              </div>
              </a>
            `;
          }
        }).join('');
      } else {
        documentsContainer.innerHTML = `
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            No documents available.
          </div>
        `;
      }

      const policiesContainer = document.getElementById('staffPolicies');
      if (resources.policies && resources.policies.length > 0) {
        policiesContainer.innerHTML = resources.policies.map((item, index) => {
          if (item.isFolder) {
            const folderId = `policies-folder-${index}`;
            const subfolderContents = item.contents.map(subItem => `
              <a href="${subItem.url}" target="_blank" 
                 class="list-group-item list-group-item-action ms-3">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">${subItem.name}</h6>
                  <small class="text-muted">${subItem.lastUpdated}</small>
                </div>
              </a>
            `).join('');
            
            return `
              <div class="list-group-item">
                <h5 class="mb-1 folder-header" onclick="toggleFolder('${folderId}', event)">
                  <i class="bi bi-folder-fill me-2"></i>
                  <i class="bi bi-caret-right-fill" id="${folderId}-caret"></i>
                  ${item.name}
                </h5>
                <div class="collapse" id="${folderId}">
                  ${subfolderContents}
                </div>
              </div>
            `;
          } else {
            return `
              <a href="${item.url}" target="_blank" 
                 class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                  <h5 class="mb-1">
                    <i class="bi bi-file-text me-2"></i>
                    ${item.name}
                  </h5>
                  <small class="text-muted">${item.lastUpdated}</small>
                </div>
              </a>
            `;
          }
        }).join('');
      } else {
        policiesContainer.innerHTML = `
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            No policies available.
          </div>
        `;
      }
    })
    .withFailureHandler(function(error) {
      document.getElementById('staffDocuments').innerHTML = `
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-circle"></i>
          Error loading documents: ${error.message}
        </div>
      `;
      document.getElementById('staffPolicies').innerHTML = `
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-circle"></i>
          Error loading policies: ${error.message}
        </div>
      `;
    })
    .getStaffResources();
}

window.onload = function() {
  showSection('home');
};
</script>
